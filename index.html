<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Sogni-Mon: Magic Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Georgia', serif; background: #0d0d0d; color: #e0e0e0; text-align: center; padding: 20px; }
        #chat { height: 300px; border: 2px solid #332d21; overflow-y: auto; background: #1a1a1a; margin: 20px auto; width: 95%; max-width: 600px; padding: 15px; border-radius: 8px; box-shadow: inset 0 0 10px #000; text-align: left; }
        .magic-card { border: 5px solid #332d21; background: #2c2c2c; padding: 10px; margin: 15px auto; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); max-width: 300px; }
        .magic-card img { width: 100%; border: 2px solid #000; border-radius: 4px; }
        .stats { font-weight: bold; color: gold; font-size: 1.2em; margin-top: 5px; text-align: right; }
        input { background: #111; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; }
        button { background: #4a3c28; color: gold; border: 1px solid gold; padding: 10px 15px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        button:hover { background: #5d4b32; }
        .id-label { color: #00ff41; font-family: monospace; font-size: 1.1em; margin-bottom: 20px; border: 1px solid #00ff41; display: inline-block; padding: 5px 15px; }
    </style>
</head>
<body>
    <h1>ðŸ“œ GLOBAL EVOCATION SYSTEM</h1>
    <div class="id-label">IL TUO ID: <span id="my-id">Sincronizzazione...</span></div>

    <div id="chat"></div>

    <div style="margin-bottom: 15px;">
        <input type="text" id="friend-id" placeholder="ID Amico">
        <button onclick="connetti()">CONNETTI</button>
    </div>
    
    <div>
        <input type="text" id="msg" placeholder="Descrivi il tuo sogno...">
        <button onclick="invia()">INVIA</button>
    </div>

    <script>
        const peer = new Peer();
        let conn;
        let msgCount = 0;
        let testoTotale = "";

        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
        });

        peer.on('connection', (c) => {
            conn = c;
            setup();
        });

        function connetti() {
            const idAmico = document.getElementById('friend-id').value;
            conn = peer.connect(idAmico);
            setup();
        }

        function setup() {
            conn.on('open', () => {
                document.getElementById('chat').innerHTML += "<p style='color:cyan;'><i>> Collegamento mentale stabilito.</i></p>";
                conn.on('data', (data) => {
                    mostra(data, 'Amico');
                });
            });
        }

        function invia() {
            const m = document.getElementById('msg').value;
            if(conn && m) {
                conn.send(m);
                mostra(m, 'Tu');
                document.getElementById('msg').value = '';
            }
        }

        function mostra(t, chi) {
            msgCount++;
            testoTotale += " " + t.toLowerCase();
            const b = document.getElementById('chat');
            b.innerHTML += `<p><b>${chi}:</b> ${t}</p>`;
            
            if(msgCount % 5 === 0) {
                evocaMagic();
            }
            b.scrollTop = b.scrollHeight;
        }

        function evocaMagic() {
            const b = document.getElementById('chat');
            let tema = "fantasy,dark";
            
            if(testoTotale.includes("fuoco") || testoTotale.includes("drago")) tema = "dragon,fire";
            if(testoTotale.includes("bosco") || testoTotale.includes("natura")) tema = "forest,druid";
            if(testoTotale.includes("mare") || testoTotale.includes("acqua")) tema = "ocean,kraken";
            if(testoTotale.includes("morte") || testoTotale.includes("nero")) tema = "skeleton,undead";
            if(testoTotale.includes("mago") || testoTotale.includes("magia")) tema = "wizard,ethereal";

            const attacco = Math.floor(Math.random() * 9) + 1;
            const difesa = Math.floor(Math.random() * 9) + 1;
            const seed = Math.random();
            const url = `https://loremflickr.com/300/400/${tema}/all?lock=${msgCount}`;

            b.innerHTML += `
                <div class="magic-card">
                    <img src="${url}" alt="Creatura">
                    <div style="padding:5px;">
                        <div style="font-weight:bold; color:gold;">Creatura Evocata</div>
                        <div style="font-size:0.8em; font-style:italic;">"${testoTotale.substring(0, 40)}..."</div>
                        <div class="stats">${attacco}/${difesa}</div>
                    </div>
                </div>`;
            testoTotale = "";
        }
    </script>
</body>
</html>
