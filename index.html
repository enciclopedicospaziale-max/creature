<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Neural Grimoire v6.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        :root { --gold: #d4af37; --bg: #080808; --card-bg: #121212; }
        body { background: var(--bg); color: var(--gold); font-family: 'Palatino', serif; margin: 0; padding: 20px; overflow-x: hidden; }
        
        /* CONTENITORE CHAT */
        #chat { 
            height: 400px; max-width: 800px; margin: 0 auto;
            background: #000; border: 3px solid #2a2a2a; border-radius: 15px;
            overflow-y: auto; padding: 20px; box-shadow: inset 0 0 50px #000, 0 0 20px rgba(212,175,55,0.1);
        }

        /* STILE CARTA "IL BISCOTTO" */
        .card-wrapper { display: inline-block; margin: 30px; perspective: 1000px; }
        .magic-card {
            background: var(--card-bg); width: 300px; border-radius: 18px; padding: 15px;
            border: 5px solid #1a1a1a; box-shadow: 0 15px 50px #000;
            position: relative; animation: summonAnim 0.8s cubic-bezier(0.23, 1, 0.32, 1);
            background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
        }
        .magic-card::before {
            content: ""; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, transparent, var(--gold), transparent);
            z-index: -1; border-radius: 20px; opacity: 0.3;
        }
        .card-header { font-weight: bold; text-transform: uppercase; border-bottom: 2px solid var(--gold); margin-bottom: 10px; padding-bottom: 5px; font-size: 1.1em; }
        .card-art { 
            width: 100%; height: 350px; background: #000; border-radius: 10px; 
            overflow: hidden; border: 2px solid #333; box-shadow: inset 0 0 20px #000;
        }
        .card-art img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; filter: contrast(1.1) brightness(1.1); }
        
        /* STATS */
        .power-box { 
            position: absolute; bottom: 10px; right: 10px; 
            background: #800; color: #fff; padding: 8px 15px;
            border: 3px solid var(--gold); border-radius: 10px;
            font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.2em;
        }

        /* INTERFACCIA */
        .controls { margin-top: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        input { background: #111; border: 1px solid var(--gold); color: #fff; padding: 12px; border-radius: 8px; width: 250px; }
        .btn { padding: 12px 25px; cursor: pointer; font-weight: bold; border-radius: 8px; border: none; text-transform: uppercase; transition: 0.3s; }
        .btn-link { background: #333; color: #fff; }
        .btn-evoke { background: var(--gold); color: #000; box-shadow: 0 0 20px rgba(212,175,55,0.4); }
        .btn-evoke:hover { transform: scale(1.05); background: #fff; }

        .id-label { font-family: monospace; color: #00ff41; margin-bottom: 15px; font-size: 1.1em; }

        @keyframes summonAnim {
            0% { opacity: 0; transform: rotateY(90deg) scale(0.5); filter: brightness(3); }
            100% { opacity: 1; transform: rotateY(0deg) scale(1); filter: brightness(1); }
        }
    </style>
</head>
<body>

    <div class="id-label">NEURAL-LINK ID: <span id="my-id">SINCRO IN CORSO...</span></div>

    <div id="chat"></div>

    <div class="controls">
        <input type="text" id="friend-id" placeholder="ID DEL COMPAGNO">
        <button class="btn btn-link" onclick="connect()">CONNETTI GRIMORIO</button>
    </div>

    <div class="controls">
        <input type="text" id="msg" placeholder="Descrivi il destino...">
        <button class="btn btn-link" onclick="sendMsg()">INVIA</button>
        <button class="btn btn-evoke" onclick="evoke()">✨ EVOCA CREATURA ✨</button>
    </div>

<script>
    const peer = new Peer();
    let conn;
    let dataStream = "";

    peer.on('open', id => document.getElementById('my-id').innerText = id);
    peer.on('connection', c => { conn = c; setup(); });

    function connect() {
        conn = peer.connect(document.getElementById('friend-id').value);
        setup();
    }

    function setup() {
        conn.on('open', () => {
            document.getElementById('chat').innerHTML += `<p style="color:var(--gold)">[LINK STABILITO] Inizia il rituale...</p>`;
            conn.on('data', d => {
                if(d.type === 'SUMMON') renderCard(d);
                else updateChat(d, 'Amico');
            });
        });
    }

    function sendMsg() {
        const m = document.getElementById('msg').value;
        if(conn && m) { 
            conn.send(m); 
            updateChat(m, 'Tu'); 
            document.getElementById('msg').value = ''; 
        }
    }

    function updateChat(t, chi) {
        dataStream += " " + t;
        const b = document.getElementById('chat');
        b.innerHTML += `<p><b>${chi}:</b> ${t}</p>`;
        b.scrollTop = b.scrollHeight;
    }

    function evoke() {
        if(!dataStream.trim() || !conn) return alert("Il flusso magico è vuoto!");
        
        const content = dataStream.toLowerCase();
        const sizeMultiplier = Math.min(2, 1 + (dataStream.length / 500));
        
        // --- PROCESSO DI GENERAZIONE STUDIATO ---
        // Traduciamo i concetti in prompt artistici MTG
        let artPrompt = "Digital fantasy painting, MTG card art style, high-detail illustration, Greg Rutkowski vibe, vibrant mystical lighting, cinematic composition, epic creature design, NO PHOTOGRAPHY, NO REALISM, vivid colors";
        
        if(content.includes("drago")) artPrompt += ", massive dragon scales, fire breath, ancient wyrm";
        if(content.includes("balestra")) artPrompt += ", intricate mechanical crossbow, wood and brass, legendary weapon";
        if(content.includes("dolce") || content.includes("bello")) artPrompt += ", ethereal glow, angelic aura, majestic scenery, masterpiece art";
        if(content.includes("sporco") || content.includes("oscuro")) artPrompt += ", dark corrupted energy, swampy atmosphere, necromancy style";

        // Costruiamo l'URL con seed unico per evitare cache e blocchi
        const seed = Math.floor(Math.random() * 999999);
        const finalUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(artPrompt + " -- Subject: " + dataStream)}?seed=${seed}&width=512&height=768&model=flux&nologo=true`;

        // Statistiche bilanciate
        const atk = Math.floor(Math.random() * 5000) + (dataStream.length * 10);
        const def = Math.floor(Math.random() * 5000) + (dataStream.length * 8);

        const cardData = {
            type: 'SUMMON',
            url: finalUrl,
            title: dataStream.trim().substring(0, 15),
            atk: atk,
            def: def,
            scale: sizeMultiplier
        };

        conn.send(cardData);
        renderCard(cardData);
        dataStream = "";
    }

    function renderCard(d) {
        const b = document.getElementById('chat');
        b.innerHTML += `
            <div class="card-wrapper" style="transform: scale(${d.scale})">
                <div class="magic-card">
                    <div class="card-header">${d.title}</div>
                    <div class="card-art">
                        <img src="${d.url}" onload="this.style.opacity=1" style="opacity:0">
                    </div>
                    <div style="font-size: 0.8em; margin-top:10px; color:#888; font-style:italic">Creatura Neurale Evocata</div>
                    <div class="power-box">${d.atk} / ${d.def}</div>
                </div>
            </div>`;
        b.scrollTop = b.scrollHeight;
    }
</script>
</body>
</html>
